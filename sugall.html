<!DOCTYPE html>
<html lang="en">
<head>
  <base target="_self">
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>WILYONARYO – Cube Slots (Stable Full Features)</title>

  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.6.0/css/all.min.css"/>

  <style>
    :root{
      --emerald:#00E3B0; --gold:#FFD54A; --gold-2:#FFE27A;
      --overlay1:rgba(7,11,22,.86); --overlay2:rgba(11,22,48,.86);
      --solid:#00E3B0;                  /* spinning color (locked on STOP) */
      --radius:18px; --br:14px;         /* cube corner radius */
      --cube:128px; --tz:64px; --fs:2rem;
      --ease:cubic-bezier(.22,1,.36,1);
    }
    @media (max-width:520px){ :root{ --cube:96px; --tz:48px; --fs:1.6rem } }
    @media (min-width:1536px){ :root{ --cube:152px; --tz:76px; --fs:2.2rem } }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      font-family: "Poppins", system-ui, -apple-system, Segoe UI, Roboto, Inter, "Helvetica Neue", Arial, sans-serif;
      color:#e9faff; overflow-x:hidden;
      background:
        linear-gradient(180deg, var(--overlay1) 0%, var(--overlay2) 100%),
        url('https://i.ibb.co/sdCxXQMH/signal-2025-10-23-135207-002.jpg') center/cover fixed no-repeat;
    }

    .glass{background:rgba(15,23,42,.55); border:1px solid rgba(255,255,255,.16); border-radius:var(--radius); backdrop-filter:blur(10px);
      box-shadow:inset 0 1px 0 rgba(255,255,255,.05),0 10px 28px rgba(0,0,0,.45)}

    .btn{display:inline-flex;align-items:center;gap:.6rem;font-weight:800;padding:.8rem 1rem;border-radius:14px;border:1px solid rgba(255,255,255,.12);
      transition:transform .15s var(--ease), box-shadow .15s var(--ease), filter .2s var(--ease)}
    .btn:focus-visible{outline:2px solid var(--gold); outline-offset:2px}
    .btn:active{transform:translateY(1px) scale(.99)}
    .btn-start{background:linear-gradient(90deg, #00cfa6, var(--emerald)); box-shadow:0 10px 26px rgba(0,227,176,.38)}
    .btn-stop{background:linear-gradient(90deg, #ff4b6e, #ff2d55); box-shadow:0 10px 26px rgba(255,45,85,.35)}
    .btn-ghost{background:rgba(255,255,255,.08)}
    .btn-disabled{opacity:.55; pointer-events:none; filter:grayscale(.2)}

    .rack{display:grid;grid-template-columns:repeat(2,minmax(0,1fr));gap:2.2rem;place-items:center}
    @media (min-width:1024px){ .rack{grid-template-columns:repeat(4,minmax(0,1fr))} }
    .cube-wrap{width:var(--cube);height:var(--cube);perspective:1100px}
    .cube{position:relative;width:100%;height:100%;transform-style:preserve-3d;will-change:transform}
    .face{
      position:absolute;inset:0;display:flex;align-items:center;justify-content:center;
      font-weight:900;font-size:var(--fs);color:#0c1020;user-select:none;backface-visibility:hidden;
      border:2px solid rgba(0,0,0,.22); border-radius:var(--br);
      background-color:var(--solid);
      transition: background-color 40ms linear, border-radius 220ms var(--ease);
      box-shadow:inset 0 0 14px rgba(255,255,255,.18),0 10px 18px rgba(0,0,0,.35),0 20px 36px rgba(0,0,0,.28);
    }
    .front  { transform: rotateY(  0deg) translateZ(var(--tz)); }
    .back   { transform: rotateY(180deg) translateZ(var(--tz)); }
    .right  { transform: rotateY( 90deg) translateZ(var(--tz)); }
    .left   { transform: rotateY(-90deg) translateZ(var(--tz)); }
    .top    { transform: rotateX( 90deg) translateZ(var(--tz)); }
    .bottom { transform: rotateX(-90deg) translateZ(var(--tz)); }

    @keyframes float {0%,100%{transform:translateY(0)}50%{transform:translateY(-12px)}}
    .floating{animation:float 3.6s ease-in-out infinite}

    .hold{position:absolute;left:50%;transform:translateX(-50%);bottom:-42px}
    .hold input{display:none}
    .hold label{
      display:inline-flex;align-items:center;gap:.5rem;cursor:pointer;padding:.38rem .7rem;border-radius:999px;font-size:.8rem;font-weight:700;
      background:rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.16);backdrop-filter:blur(6px)
    }
    .hold input:checked + label{background:linear-gradient(90deg, var(--gold), var(--gold-2));color:#111}

    @keyframes winGlow{0%,100%{box-shadow:0 0 0 rgba(255,213,74,0)}50%{box-shadow:0 0 28px rgba(255,213,74,.85)}}
    .win .face{animation:winGlow 1.2s ease-in-out 2}

    @keyframes confetti{0%{transform:translateY(-100px) rotate(0deg);opacity:1}100%{transform:translateY(100vh) rotate(360deg);opacity:0}}
    .confetti{position:absolute;width:10px;height:10px;animation:confetti 3s linear forwards}

    .mobile-controls{position:sticky; bottom:0; left:0; right:0; z-index:30; margin-top:.25rem}
    @media (min-width:768px){ .mobile-controls{display:none} }

    .tg-letter{
      text-transform:uppercase;text-align:center;font-weight:800;letter-spacing:.04em;
    }
    .tg-letter:disabled{opacity:.75}
    .error-hint{opacity:0; transition:opacity .2s}
    .error-hint.show{opacity:1}
  </style>
</head>
<body class="min-h-screen py-6 px-4 md:px-6">
  <!-- Header -->
  <header class="max-w-7xl mx-auto mb-6">
    <div class="glass p-5">
      <div class="flex flex-col gap-4 md:flex-row md:items-center md:justify-between">
        <div class="flex items-center gap-3">
          <div class="h-12 w-12 rounded-xl bg-white/10 grid place-items-center ring-1 ring-white/20">
            <span id="avatarInitials" class="font-extrabold text-xl">PL</span>
          </div>
          <div>
            <h1 class="text-2xl md:text-4xl font-black">WILYONARYO</h1>
            <p class="text-xs md:text-sm text-white/85">Cube Slots • Full features stable</p>
          </div>
        </div>

        <div class="flex flex-wrap items-center gap-3">
          <div class="glass px-3 py-2 rounded-lg flex items-center gap-2">
            <i class="fa-regular fa-user text-yellow-300"></i>
            <input id="playerName" class="bg-transparent outline-none w-32 md:w-44" placeholder="Your name"/>
            <button id="saveName" class="btn btn-ghost text-xs">Save</button>
          </div>
          <div class="glass px-3 py-2 rounded-lg flex items-center gap-2">
            <i class="fa-solid fa-wallet text-emerald-300"></i>
            <span class="text-white/80">Balance:</span>
            <strong id="balanceText" class="font-extrabold">₱0.00</strong>
            <button id="add50" class="btn btn-ghost text-xs" title="Add ₱50">+₱50</button>
            <button id="resetData" class="btn btn-ghost text-xs" title="Reset data">Reset</button>
          </div>
        </div>
      </div>
    </div>
  </header>

  <!-- Controls -->
  <section class="max-w-7xl mx-auto glass p-5 md:p-6">
    <div class="grid xl:grid-cols-3 gap-6">
      <!-- Play -->
      <div>
        <h2 class="text-xl md:text-2xl font-extrabold">PLAY</h2>
        <p class="text-white/85 mt-1">Bet sa <b>letters</b> (exact 4, unique) at/o <b>kulay</b>.</p>

        <div class="mt-4 flex flex-wrap items-center gap-2">
          <div class="glass px-3 py-2 rounded-lg flex items-center gap-2">
            <i class="fa-solid fa-coins text-yellow-300"></i>
            <label for="betInput">Bet</label>
            <input id="betInput" type="number" min="2" step="1" class="bg-transparent outline-none w-24" value="2"/>
            <span class="opacity-80">₱ (min 2)</span>
          </div>
          <div class="flex gap-2">
            <button class="btn btn-ghost text-xs" data-quickbet="2">+₂</button>
            <button class="btn btn-ghost text-xs" data-quickbet="5">+₅</button>
            <button class="btn btn-ghost text-xs" data-quickbet="10">+₁₀</button>
            <button class="btn btn-ghost text-xs" id="betMax">MAX</button>
          </div>
        </div>

        <div class="mt-4 hidden md:flex flex-wrap items-center gap-3">
          <button id="startBtn" class="btn btn-start"><i class="fa-solid fa-play"></i> START</button>
          <button id="stopBtn" class="btn btn-stop" disabled><i class="fa-solid fa-stop"></i> STOP</button>

          <div class="glass px-3 py-2 rounded-lg text-sm inline-flex items-center gap-2">
            <i class="fa-solid fa-gauge text-yellow-300"></i>
            <label for="speedSel" class="whitespace-nowrap">Speed</label>
            <select id="speedSel" class="bg-transparent outline-none">
              <option value="fast">Fast</option>
              <option value="normal" selected>Normal</option>
              <option value="slow">Slow</option>
            </select>
          </div>
        </div>

        <div id="resultBar" class="mt-4 hidden">
          <div class="glass p-3 rounded-lg flex flex-col sm:flex-row sm:items-center sm:justify-between gap-3">
            <div class="flex items-center gap-3">
              <i id="resultIcon" class="fa-solid fa-circle-info"></i>
              <div>
                <div id="resultText" class="font-semibold">—</div>
                <div class="text-xs opacity-80" id="resultSub">—</div>
              </div>
            </div>
            <div class="flex items-center gap-2">
              <span class="opacity-80">Locked Color:</span>
              <span id="winColorName" class="font-bold">—</span>
              <span id="winColorSwatch" class="inline-block w-5 h-5 rounded-md ring-1 ring-white/20"></span>
            </div>
          </div>
        </div>

        <div class="grid grid-cols-3 gap-3 mt-4">
          <div class="glass p-3 text-center">
            <div class="text-xl text-yellow-300 mb-1"><i class="fa-solid fa-arrows-rotate"></i></div>
            <div id="spinCount" class="text-lg font-extrabold">0</div>
            <div class="text-white/70 text-xs">Spins</div>
          </div>
          <div class="glass p-3 text-center">
            <div class="text-xl text-emerald-300 mb-1"><i class="fa-solid fa-trophy"></i></div>
            <div id="winCount" class="text-lg font-extrabold">0</div>
            <div class="text-white/70 text-xs">Wins</div>
          </div>
          <div class="glass p-3 text-center">
            <div class="text-xl text-sky-300 mb-1"><i class="fa-solid fa-bolt"></i></div>
            <div id="comboCount" class="text-lg font-extrabold">0</div>
            <div class="text-white/70 text-xs">Combos</div>
          </div>
        </div>
      </div>

      <!-- Target Letters -->
      <div class="glass p-4">
        <div class="flex items-center justify-between">
          <h3 class="font-bold text-lg">Target Letters (4, unique)</h3>
          <div class="flex gap-2">
            <button id="tgRandom" class="btn btn-ghost text-xs">Random</button>
            <button id="tgClear" class="btn btn-ghost text-xs">Clear</button>
          </div>
        </div>
        <p class="text-white/75 text-sm mt-1">Exact order ang panalo. Walang double letter.</p>

        <div class="mt-3 grid grid-cols-4 gap-2">
          <input class="tg-letter glass py-2 rounded-lg uppercase" maxlength="1" placeholder="A">
          <input class="tg-letter glass py-2 rounded-lg uppercase" maxlength="1" placeholder="B">
          <input class="tg-letter glass py-2 rounded-lg uppercase" maxlength="1" placeholder="C">
          <input class="tg-letter glass py-2 rounded-lg uppercase" maxlength="1" placeholder="D">
        </div>
        <div class="mt-2 text-xs text-red-300 error-hint" id="dupHint">Duplicate letter! Hindi puwedeng maulit.</div>

        <div class="mt-3 flex flex-wrap items-center gap-3">
          <label class="flex items-center gap-2 text-sm">
            <input id="betCombo" type="checkbox" class="accent-emerald-400">
            Bet on Combo (×10)
          </label>
          <button id="submitTargets" class="btn text-xs hidden"><i class="fa-solid fa-check"></i> Submit Targets</button>
          <button id="unlockTargets" class="btn btn-ghost text-xs hidden"><i class="fa-solid fa-unlock"></i> Unlock</button>
          <span id="tgError" class="text-xs text-red-300 hidden">Kailangang 4 unique A–Z.</span>
          <span id="tgOK" class="text-xs text-emerald-300 hidden">Targets locked!</span>
        </div>
      </div>

      <!-- Target Color -->
      <div class="glass p-4">
        <div class="flex items-center justify-between">
          <h3 class="font-bold text-lg">Target Color</h3>
          <button id="tgColorClear" class="btn btn-ghost text-xs">Clear</button>
        </div>
        <p class="text-white/75 text-sm mt-1">Tatama kung ang final locked color ay kapareho ng pinili mo.</p>

        <div id="colorGrid" class="mt-3 grid grid-cols-6 gap-2"></div>

        <div class="mt-3 flex items-center gap-3">
          <label class="flex items-center gap-2 text-sm">
            <input id="betColor" type="checkbox" class="accent-emerald-400" checked>
            Bet on Color (×3)
          </label>
          <div class="flex items-center gap-2 text-sm">
            <span class="opacity-80">Selected:</span>
            <span id="selColorName" class="font-semibold">—</span>
            <span id="selColorSwatch" class="inline-block w-4 h-4 rounded ring-1 ring-white/20"></span>
          </div>
        </div>
      </div>
    </div>
  </section>

  <!-- Cubes -->
  <section class="max-w-7xl mx-auto mt-8">
    <div class="rack">
      <div class="cube-wrap relative">
        <div class="cube floating" id="cube1">
          <div class="face front"></div><div class="face back"></div><div class="face right"></div>
          <div class="face left"></div><div class="face top"></div><div class="face bottom"></div>
        </div>
        <div class="hold"><input type="checkbox" id="hold1"/><label for="hold1"><i class="fa-solid fa-lock"></i> HOLD</label></div>
      </div>
      <div class="cube-wrap relative">
        <div class="cube floating" id="cube2">
          <div class="face front"></div><div class="face back"></div><div class="face right"></div>
          <div class="face left"></div><div class="face top"></div><div class="face bottom"></div>
        </div>
        <div class="hold"><input type="checkbox" id="hold2"/><label for="hold2"><i class="fa-solid fa-lock"></i> HOLD</label></div>
      </div>
      <div class="cube-wrap relative">
        <div class="cube floating" id="cube3">
          <div class="face front"></div><div class="face back"></div><div class="face right"></div>
          <div class="face left"></div><div class="face top"></div><div class="face bottom"></div>
        </div>
        <div class="hold"><input type="checkbox" id="hold3"/><label for="hold3"><i class="fa-solid fa-lock"></i> HOLD</label></div>
      </div>
      <div class="cube-wrap relative">
        <div class="cube floating" id="cube4">
          <div class="face front"></div><div class="face back"></div><div class="face right"></div>
          <div class="face left"></div><div class="face top"></div><div class="face bottom"></div>
        </div>
        <div class="hold"><input type="checkbox" id="hold4"/><label for="hold4"><i class="fa-solid fa-lock"></i> HOLD</label></div>
      </div>
    </div>

    <div class="mobile-controls">
      <div class="glass p-2 mt-3 flex items-center justify-center gap-3">
        <button id="startBtn2" class="btn btn-start w-1/2"><i class="fa-solid fa-play"></i> START</button>
        <button id="stopBtn2" class="btn btn-stop w-1/2" disabled><i class="fa-solid fa-stop"></i> STOP</button>
      </div>
    </div>
  </section>

  <!-- Combination -->
  <section class="max-w-7xl mx-auto mt-8">
    <div class="glass p-5 text-center">
      <h3 class="text-lg md:text-xl font-bold mb-2">YOUR LUCKY COMBINATION</h3>
      <div id="combination" class="text-4xl md:text-6xl font-black tracking-[.25em]">- - - -</div>
      <p class="text-white/75 mt-2">Exact combo ×10 • Color match ×3</p>
    </div>
  </section>

  <!-- History -->
  <section class="max-w-7xl mx-auto mt-8 glass p-5">
    <div class="flex items-center justify-between">
      <h4 class="font-bold text-lg">Game History</h4>
      <div class="flex gap-2">
        <button id="exportHistory" class="btn btn-ghost text-xs">Export CSV</button>
        <button id="clearHistory" class="btn btn-ghost text-xs">Clear</button>
      </div>
    </div>
    <div class="overflow-x-auto mt-3">
      <table class="min-w-full text-sm">
        <thead class="text-white/80">
          <tr>
            <th class="text-left py-2 pr-4">Time</th>
            <th class="text-left py-2 pr-4">Combo</th>
            <th class="text-left py-2 pr-4">Result</th>
            <th class="text-right py-2 pr-4">Bet</th>
            <th class="text-right py-2 pr-4">Payout</th>
            <th class="text-left py-2 pr-4">Locked Color</th>
          </tr>
        </thead>
        <tbody id="historyBody"></tbody>
      </table>
    </div>
  </section>

  <script>
  (function(){
    /* ===== Constants ===== */
    const LETTERS = "ABCDEFGHIJKLMNOPQRSTUVWXYZ".split("");
    const COLOR_SET = [
      {name:"Emerald", hex:"#00E3B0"},
      {name:"Teal",    hex:"#00C79A"},
      {name:"Cyan",    hex:"#22D3EE"},
      {name:"Mint",    hex:"#6EE7B7"},
      {name:"Sky",     hex:"#93C5FD"},
      {name:"Violet",  hex:"#A78BFA"},
      {name:"Gold",    hex:"#FFD54A"},
      {name:"Lemon",   hex:"#FFE27A"},
      {name:"Pink",    hex:"#FF4D9D"},
      {name:"Aqua",    hex:"#45B7D1"},
      {name:"Jade",    hex:"#1ABC9C"},
      {name:"Amber",   hex:"#F8C471"}
    ];
    const PAYOUTS = { combo:10, color:3 };
    const STORAGE_KEY = "wily_full_stable_v1";

    const qs = (s, r=document)=>r.querySelector(s);
    const qsa = (s, r=document)=>Array.from(r.querySelectorAll(s));

    /* ===== DOM refs ===== */
    const els = {
      avatar: qs("#avatarInitials"),
      playerName: qs("#playerName"),
      saveName: qs("#saveName"),
      balanceText: qs("#balanceText"),
      add50: qs("#add50"),
      reset: qs("#resetData"),
      bet: qs("#betInput"),
      betMax: qs("#betMax"),
      start: qs("#startBtn"),
      stop: qs("#stopBtn"),
      start2: qs("#startBtn2"),
      stop2: qs("#stopBtn2"),
      speed: qs("#speedSel"),
      resultBar: qs("#resultBar"),
      resultIcon: qs("#resultIcon"),
      resultText: qs("#resultText"),
      resultSub: qs("#resultSub"),
      winColorName: qs("#winColorName"),
      winColorSwatch: qs("#winColorSwatch"),
      spinCount: qs("#spinCount"),
      winCount: qs("#winCount"),
      comboCount: qs("#comboCount"),
      historyBody: qs("#historyBody"),
      exportHistory: qs("#exportHistory"),
      clearHistory: qs("#clearHistory"),
      combination: qs("#combination"),
      tgInputs: qsa(".tg-letter"),
      tgRandom: qs("#tgRandom"),
      tgClear: qs("#tgClear"),
      tgError: qs("#tgError"),
      tgOK: qs("#tgOK"),
      dupHint: qs("#dupHint"),
      submitTargets: qs("#submitTargets"),
      unlockTargets: qs("#unlockTargets"),
      betCombo: qs("#betCombo"),
      colorGrid: qs("#colorGrid"),
      tgColorClear: qs("#tgColorClear"),
      selColorName: qs("#selColorName"),
      selColorSwatch: qs("#selColorSwatch"),
      betColor: qs("#betColor"),
    };

    const cubeIds = ["cube1","cube2","cube3","cube4"];
    const holdIds = ["hold1","hold2","hold3","hold4"];
    const cubes = cubeIds.map(id=>({ id, el: qs("#"+id), rx: Math.random()*360, ry: Math.random()*360, vx:0, vy:0, active:false }));
    let currentLetters = ["-","-","-","-"];
    let letterTimers = [null,null,null,null];
    let colorTimer = null;
    let lastFlashColor = getComputedStyle(document.documentElement).getPropertyValue("--solid").trim() || "#00E3B0";
    let isSpinning = false, rafId = null, lastT = 0, pendingBet = 0;

    /* ===== State ===== */
    const state = {
      name:"Player",
      balance:100,
      history:[],
      stats:{spins:0,wins:0,combos:0},
      target:{letters:["","","",""], color:null},
      betOn:{combo:false, color:true},
      targetsSubmitted:false
    };

    /* ===== Utils ===== */
    const setSolid = (c)=> document.documentElement.style.setProperty("--solid", c);
    const setBR = (px)=> document.documentElement.style.setProperty("--br", px+"px");
    const fmt = n=>"₱"+Number(n).toFixed(2);
    const nowText = ()=> new Date().toLocaleString();
    const toast = (msg, ok=true)=>{
      const t=document.createElement("div");
      t.className="fixed bottom-4 left-1/2 -translate-x-1/2 z-50 px-4 py-2 rounded-lg text-sm glass";
      t.style.borderColor = ok ? "rgba(0,227,176,.6)" : "rgba(255,77,77,.6)";
      t.textContent=msg; document.body.appendChild(t); setTimeout(()=>t.remove(),1800);
    }
    function save(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
    function load(){ try{const raw=localStorage.getItem(STORAGE_KEY); if(raw) Object.assign(state, JSON.parse(raw));}catch{} }
    function syncStartStopDisabled(startDisabled, stopDisabled){
      [els.start,els.start2].forEach(b=>{ b.disabled=startDisabled; b.classList.toggle("btn-disabled",startDisabled); });
      [els.stop,els.stop2].forEach(b=>{ b.disabled=stopDisabled; b.classList.toggle("btn-disabled",stopDisabled); });
    }

    /* ===== Renderers ===== */
    function renderBasics(){
      els.balanceText.textContent = fmt(state.balance);
      els.spinCount.textContent = state.stats.spins;
      els.winCount.textContent = state.stats.wins;
      els.comboCount.textContent = state.stats.combos;
      els.playerName.value = state.name;
      const p=(state.name||"").trim().split(/\s+/);
      const A=p[0]?.[0]||"P", B=p[1]?.[0]||p[0]?.[1]||"L";
      els.avatar.textContent=(A+B).toUpperCase();
    }
    function renderTargets(){
      els.tgInputs.forEach((inp,i)=>{ inp.value=state.target.letters[i]||""; inp.disabled=state.targetsSubmitted; });
      els.betCombo.checked=!!state.betOn.combo; els.betColor.checked=!!state.betOn.color;

      if(state.target.color){
        els.selColorName.textContent=state.target.color.name;
        els.selColorSwatch.style.background=state.target.color.hex;
      }else{ els.selColorName.textContent="—"; els.selColorSwatch.style.background="transparent"; }

      els.tgOK.classList.toggle("hidden", !state.targetsSubmitted);
      els.unlockTargets.classList.toggle("hidden", !state.targetsSubmitted);
      updateSubmitVisibility();
    }
    function renderHistory(){
      const tbody=els.historyBody; tbody.innerHTML="";
      if(state.history.length===0){ tbody.innerHTML=`<tr><td class="py-3 text-white/70" colspan="6">No games yet.</td></tr>`; return; }
      state.history.slice(0,150).forEach(h=>{
        const tr=document.createElement("tr");
        tr.innerHTML=`
          <td class="py-2 pr-4 whitespace-nowrap">${h.t}</td>
          <td class="py-2 pr-4">${h.combo}</td>
          <td class="py-2 pr-4 ${/Win/.test(h.winText)?'text-emerald-300':'text-red-300'}">${h.winText}</td>
          <td class="py-2 pr-4 text-right">${fmt(h.bet)}</td>
          <td class="py-2 pr-4 text-right">${fmt(h.payout)}</td>
          <td class="py-2 pr-4">
            <span class="inline-flex items-center gap-2">
              <span class="inline-block w-4 h-4 rounded ring-1 ring-white/20" style="background:${h.colorHex}"></span>
              <span>${h.colorName||'—'}</span>
            </span>
          </td>`;
        tbody.appendChild(tr);
      });
    }
    function setResultBar({text, sub, colorName, colorHex, win}){
      els.resultBar.classList.remove("hidden");
      els.resultIcon.className = win ? "fa-solid fa-trophy text-emerald-300" : "fa-solid fa-circle-info text-white/80";
      els.resultText.textContent = text;
      els.resultSub.textContent = sub;
      els.winColorName.textContent = colorName || "—";
      els.winColorSwatch.style.background = colorHex || "transparent";
    }

    /* ===== Color Picker ===== */
    function buildColorPicker(){
      els.colorGrid.innerHTML="";
      COLOR_SET.forEach(c=>{
        const b=document.createElement("button");
        b.className="w-full aspect-square rounded-lg ring-1 ring-white/25 hover:ring-white/60";
        b.title=c.name; b.style.background=c.hex;
        b.addEventListener("click",()=>{ state.target.color={name:c.name,hex:c.hex}; save(); renderTargets(); });
        els.colorGrid.appendChild(b);
      });
      els.tgColorClear.addEventListener("click",()=>{ state.target.color=null; save(); renderTargets(); });
    }

    /* ===== Spin Engine ===== */
    function speedLetterTick(){ const v=els.speed.value; return v==="fast"?50: v==="slow"?110: 75; }
    function speedColorTick(){ const v=els.speed.value; return v==="fast"?30: v==="slow"?70: 45; }
    function baseSpinVel(){ const v=els.speed.value; return v==="fast"?720: v==="slow"?300: 520; }
    function jitterVel(){ const v=els.speed.value; return v==="fast"?70: v==="slow"?30: 50; }

    function updateCombination(){ els.combination.textContent=currentLetters.join(" "); }

    function startColorFlashing(){
      stopColorFlashing();
      colorTimer=setInterval(()=>{
        const pick = COLOR_SET[Math.floor(Math.random()*COLOR_SET.length)];
        lastFlashColor = pick.hex; setSolid(lastFlashColor);
      }, speedColorTick());
    }
    function stopColorFlashing(){ if(colorTimer){ clearInterval(colorTimer); colorTimer=null; } }

    function startLetters(i){
      stopLetters(i);
      const tick=speedLetterTick();
      letterTimers[i]=setInterval(()=>{
        const L = LETTERS[Math.floor(Math.random()*LETTERS.length)];
        cubes[i].el.querySelectorAll(".face").forEach(f=>f.textContent=L);
        currentLetters[i]=L; updateCombination();
      }, tick + Math.floor(Math.random()*20));
    }
    function stopLetters(i){ if(letterTimers[i]){ clearInterval(letterTimers[i]); letterTimers[i]=null; } }

    function physicsLoop(ts){
      if(!lastT) lastT=ts;
      const dt=(ts-lastT)/1000; lastT=ts;
      let any=false;
      for(const c of cubes){
        if(!c.active) continue; any=true;
        c.rx += c.vx*dt; c.ry += c.vy*dt;
        c.el.style.transform = `rotateX(${c.rx}deg) rotateY(${c.ry}deg)`;
        if(!isSpinning){
          c.vx*=0.90; c.vy*=0.90;
          if(Math.abs(c.vx)<6 && Math.abs(c.vy)<6){
            const sx=Math.round(c.rx/5)*5, sy=Math.round(c.ry/5)*5;
            c.active=false; c.vx=0; c.vy=0; c.rx=sx; c.ry=sy;
            c.el.style.transition="transform 360ms var(--ease)";
            c.el.style.transform=`rotateX(${sx}deg) rotateY(${sy}deg)`;
            setTimeout(()=>{ c.el.style.transition=""; c.el.classList.add("floating"); }, 380);
          }
        }
      }
      if(any || isSpinning){ rafId=requestAnimationFrame(physicsLoop); } else { rafId=null; }
    }

    function finalizeUniqueLetters(){
      const held=new Set();
      holdIds.forEach((hid,i)=>{
        if(qs("#"+hid).checked){
          const L=currentLetters[i]; if(L&&L!=="-") held.add(L);
        }
      });
      const pool=LETTERS.filter(L=>!held.has(L));
      holdIds.forEach((hid,i)=>{
        if(!qs("#"+hid).checked){
          if(held.has(currentLetters[i]) || currentLetters[i]==="-" || !pool.includes(currentLetters[i])){
            if(pool.length){
              const pick = pool.splice(Math.floor(Math.random()*pool.length),1)[0];
              currentLetters[i]=pick;
              cubes[i].el.querySelectorAll(".face").forEach(f=>f.textContent=pick);
              held.add(pick);
            }
          }else{
            const pos=pool.indexOf(currentLetters[i]); if(pos>-1) pool.splice(pos,1);
            held.add(currentLetters[i]);
          }
        }
      });
      updateCombination();
    }

    function evaluate(combo, bet){
      let total=0, parts=[];
      if(state.betOn.combo && state.targetsSubmitted){
        const tgt=state.target.letters.join("");
        if(combo===tgt){ total+= bet*PAYOUTS.combo; parts.push(`Combo ×${PAYOUTS.combo}`); }
      }
      if(state.betOn.color && state.target.color){
        if(lastFlashColor.toLowerCase()===state.target.color.hex.toLowerCase()){
          total+= bet*PAYOUTS.color; parts.push(`Color ×${PAYOUTS.color}`);
        }
      }
      const win = total>0;
      const colorName = (COLOR_SET.find(c=>c.hex.toLowerCase()===lastFlashColor.toLowerCase())||{}).name || "—";
      return {win, payout:total, winText: win?`Win (${parts.join(" + ")})`:"Lose", colorName, colorHex:lastFlashColor};
    }

    /* ===== Targets typing ===== */
    function readTargetFromInputs(){ return els.tgInputs.map(i=>(i.value||"").toUpperCase()); }
    function setInputs(v){ els.tgInputs.forEach((inp,i)=> inp.value=v[i]||""); }
    function showDupHint(show){ els.dupHint.classList.toggle("show", !!show); }
    function validTarget(){ const t=readTargetFromInputs(); if(t.some(v=>!v)) return false; return (new Set(t)).size===4; }
    function updateSubmitVisibility(){
      const canShow = validTarget() && !!state.target.color && !state.targetsSubmitted;
      els.submitTargets.classList.toggle("hidden", !canShow);
    }
    function validateAndFixInput(idx){
      const inputs = readTargetFromInputs();
      let val = inputs[idx];
      if(!val){ showDupHint(false); updateSubmitVisibility(); return true; }
      if(!/^[A-Z]$/.test(val)){ els.tgInputs[idx].value=""; showDupHint(false); updateSubmitVisibility(); return false; }
      for(let i=0;i<inputs.length;i++){
        if(i!==idx && inputs[i]===val){
          els.tgInputs[idx].value="";
          showDupHint(true); setTimeout(()=>showDupHint(false),900);
          updateSubmitVisibility(); return false;
        }
      }
      showDupHint(false);
      if(idx<3) els.tgInputs[idx+1].focus();
      updateSubmitVisibility();
      return true;
    }
    function submitTargets(){
      if(!validTarget()){ els.tgError.classList.remove("hidden"); toast("Targets invalid: 4 unique A–Z required.", false); return; }
      if(!state.target.color){ toast("Pumili ng target color.", false); return; }
      state.target.letters = readTargetFromInputs();
      state.targetsSubmitted = true;
      save(); renderTargets();
      els.tgError.classList.add("hidden"); toast("Targets submitted & locked");
    }
    function unlockTargets(){ state.targetsSubmitted=false; save(); renderTargets(); toast("Targets unlocked"); }

    /* ===== Bet validation ===== */
    function validBet(){
      const b=Number(els.bet.value||0);
      if(!Number.isFinite(b) || b<2){ toast("Minimum bet is ₱2",false); return null; }
      if(b>state.balance){ toast("Insufficient balance",false); return null; }
      if(!els.betColor.checked && !els.betCombo.checked){ toast("Piliin ang bet type (Combo at/o Color).",false); return null; }
      if(els.betCombo.checked && !state.targetsSubmitted){ toast("Submit your letters first.", false); return null; }
      if(els.betColor.checked && !state.target.color){ toast("Pumili ng target color.", false); return null; }
      return Math.floor(b);
    }

    /* ===== Flow ===== */
    function startSpin(){
      if(isSpinning) return;
      const b = validBet(); if(b===null) return;

      state.balance -= b; pendingBet=b; renderBasics(); save();
      state.stats.spins++; renderBasics(); save();

      isSpinning=true; syncStartStopDisabled(true,false); setBR(22);
      els.resultBar.classList.add("hidden");
      startColorFlashing();

      const base = (els.speed.value==="fast"?720: els.speed.value==="slow"?300:520);
      const jit  = (els.speed.value==="fast"?70 : els.speed.value==="slow"?30 :50);

      cubes.forEach((c,i)=>{
        if(qs("#"+holdIds[i]).checked) return;
        c.active=true; c.el.classList.remove("floating");
        c.vx = base + (Math.random()*2-1)*jit;
        c.vy = base + (Math.random()*2-1)*jit;
        startLetters(i);
      });

      if(!rafId){ lastT=0; rafId=requestAnimationFrame(physicsLoop); }
    }

    async function stopSpin(){
      if(!isSpinning) return;
      isSpinning=false; syncStartStopDisabled(false,true); setBR(14);
      stopColorFlashing();

      for(let i=0;i<4;i++){
        if(!qs("#"+holdIds[i]).checked) { stopLetters(i); await new Promise(r=>setTimeout(r,110)); }
      }

      finalizeUniqueLetters();
      state.stats.combos++; renderBasics(); save();

      const combo=currentLetters.join("");
      const res=evaluate(combo, pendingBet);

      if(res.win){
        setSolid(res.colorHex);
        cubeIds.forEach(id=> qs("#"+id).classList.add("win"));
        setTimeout(()=> cubeIds.forEach(id=> qs("#"+id).classList.remove("win")), 2000);
        state.stats.wins++; renderBasics(); save();
        const cont=document.createElement("div"); cont.className="fixed inset-0 pointer-events-none z-40"; document.body.appendChild(cont);
        for(let i=0;i<70;i++){
          const d=document.createElement("div"); d.className="confetti";
          d.style.left=Math.random()*100+"vw"; d.style.top="-20px";
          d.style.width=(6+Math.random()*9)+"px"; d.style.height=(6+Math.random()*9)+"px";
          d.style.borderRadius=Math.random()>.45?"2px":"50%";
          d.style.background=COLOR_SET[Math.floor(Math.random()*COLOR_SET.length)].hex;
          d.style.animationDelay=(Math.random()*1.2)+"s";
          cont.appendChild(d);
        }
        setTimeout(()=>cont.remove(),3300);
      }

      state.balance += res.payout; renderBasics(); save();

      state.history.unshift({
        t: nowText(), combo, winText: res.winText, bet: pendingBet, payout: res.payout,
        colorHex: res.colorHex, colorName: res.colorName
      });
      if(state.history.length>300) state.history.pop();
      renderHistory(); save();

      setResultBar({
        text: res.win? `PANALO! ${combo}` : `TAPOS. ${combo}`,
        sub:  res.win? `Bet ${fmt(pendingBet)} → Payout ${fmt(res.payout)}` : `Bet ${fmt(pendingBet)} → Payout ₱0.00`,
        colorName: res.colorName, colorHex: res.colorHex, win: res.win
      });

      pendingBet=0;
    }

    /* ===== Init ===== */
    function randomizeInputs(){
      if(state.targetsSubmitted) return;
      const pool=[...LETTERS], picks=[];
      for(let i=0;i<4;i++){ picks.push( pool.splice(Math.floor(Math.random()*pool.length),1)[0] ); }
      setInputs(picks); state.target.letters=[...picks]; save(); updateSubmitVisibility();
    }
    function clearInputs(){
      if(state.targetsSubmitted) return;
      setInputs(["","","",""]); state.target.letters=["","","",""]; save(); updateSubmitVisibility();
    }
    function primeCubes(){
      const all="ABCDEFGHIJKLMNOPQRSTUVWXYZ";
      cubeIds.forEach((id,i)=>{
        qs("#"+id).querySelectorAll(".face").forEach(f=>f.textContent = all[Math.floor(Math.random()*all.length)]);
        qs("#"+id).style.transform=`rotateX(${cubes[i].rx}deg) rotateY(${cubes[i].ry}deg)`;
      });
      els.combination.textContent="- - - -";
    }
    function bind(){
      // profile & wallet
      els.saveName.addEventListener("click",()=>{ state.name=(els.playerName.value||"Player").slice(0,32); save(); renderBasics(); toast("Profile saved"); });
      els.add50.addEventListener("click",()=>{ state.balance+=50; save(); renderBasics(); toast("Added ₱50"); });
      els.reset.addEventListener("click",()=>{ if(confirm("Reset all data?")){ localStorage.removeItem(STORAGE_KEY); location.reload(); } });

      // quick bets
      qsa("[data-quickbet]").forEach(b=> b.addEventListener("click",()=>{ const inc=+b.dataset.quickbet||0; els.bet.value=Math.max(2, (+els.bet.value||0)+inc); }));
      els.betMax?.addEventListener("click",()=>{ els.bet.value=Math.max(2, Math.floor(state.balance)); });

      // typing events
      els.tgInputs.forEach((inp,idx)=>{
        inp.addEventListener("input",(e)=>{
          if(state.targetsSubmitted){ e.target.value=e.target.value.toUpperCase().slice(0,1); return; }
          e.target.value = (e.target.value||"").toUpperCase().replace(/[^A-Z]/g,"").slice(0,1);
          validateAndFixInput(idx);
          state.target.letters = readTargetFromInputs(); save();
          els.tgError.classList.toggle("hidden", validTarget());
        });
        inp.addEventListener("keydown",e=>{
          if(e.key==="Backspace" && !inp.value && idx>0) els.tgInputs[idx-1].focus();
        });
      });

      els.tgRandom.addEventListener("click", randomizeInputs);
      els.tgClear.addEventListener("click", clearInputs);

      els.submitTargets.addEventListener("click", submitTargets);
      els.unlockTargets.addEventListener("click", unlockTargets);

      els.betCombo.addEventListener("change", ()=>{ state.betOn.combo=els.betCombo.checked; save(); });
      els.betColor.addEventListener("change", ()=>{ state.betOn.color=els.betColor.checked; save(); });

      // color picker + clear handled inside buildColorPicker()

      // spin buttons
      els.start.addEventListener("click", startSpin);
      els.stop.addEventListener("click",  stopSpin);
      els.start2.addEventListener("click", startSpin);
      els.stop2.addEventListener("click",  stopSpin);

      els.speed.addEventListener("change",()=>{
        if(!isSpinning) return;
        stopColorFlashing(); startColorFlashing();
        const base=baseSpinVel(), jit=jitterVel();
        cubes.forEach((c,i)=>{
          if(!c.active || qs("#"+holdIds[i]).checked) return;
          c.vx = base + (Math.random()*2-1)*jit;
          c.vy = base + (Math.random()*2-1)*jit;
          stopLetters(i); startLetters(i);
        });
      });

      // history
      els.clearHistory.addEventListener("click",()=>{ state.history=[]; save(); renderHistory(); toast("History cleared"); });
      els.exportHistory.addEventListener("click",()=>{
        if(state.history.length===0){ toast("No history to export",false); return; }
        const rows=[["Time","Combo","Result","Bet","Payout","ColorName","ColorHex"]];
        state.history.forEach(h=> rows.push([h.t,h.combo,h.winText,h.bet,h.payout,h.colorName||"",h.colorHex||""]));
        const csv=rows.map(r=>r.map(x=>`"${String(x).replaceAll('"','""')}"`).join(",")).join("\n");
        const blob=new Blob([csv],{type:"text/csv"}); const url=URL.createObjectURL(blob);
        const a=document.createElement("a"); a.href=url; a.download=`wilyonaryo_history_${Date.now()}.csv`; a.click(); URL.revokeObjectURL(url);
      });
    }

    function init(){
      load();
      buildColorPicker();
      renderBasics();
      renderTargets();
      renderHistory();
      primeCubes();
      bind();
      syncStartStopDisabled(false,true);
    }
    init();
  })();
  </script>
</body>
</html>
